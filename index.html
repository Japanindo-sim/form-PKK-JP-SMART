<!DOCTYPE html>
<html lang="id" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dasbor Permohonan Kartu - JP SMART</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Libraries for PDF, Icons, Animations, and Alerts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/hover.css/2.3.1/css/hover-min.css" xintegrity="sha512-SJw7jzjMYJhsEnN/BuxTWXkezA2cRanuBaaBCvX2ACowSbIoA5Y/slIVRaxu3loFcQxIkvcatd/OXRzAztke5g==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        /* Custom styles */
        body { 
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .uppercase-input {
            text-transform: uppercase;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <!-- Container Utama -->
    <div id="app" class="container mx-auto p-4 md:p-6 lg:p-8 max-w-7xl">

        <!-- Halaman Login -->
        <div id="login-section" class="min-h-screen flex items-center justify-center">
            <div class="max-w-md w-full bg-white p-8 rounded-2xl shadow-lg space-y-6 transform transition-all duration-500">
                <div class="text-center">
                    <i data-lucide="shield-check" class="mx-auto h-12 w-12 text-indigo-600"></i>
                    <h1 class="text-3xl font-extrabold text-slate-900 mt-4">JP SMART LOGIN</h1>
                    <p class="text-slate-500 mt-2">Silakan masuk untuk melanjutkan untuk permohonan kartu keluar</p>
                </div>
                <div class="space-y-4">
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                            <i data-lucide="user" class="h-5 w-5 text-slate-400"></i>
                        </span>
                        <input type="text" id="username" placeholder="Username" class="w-full pl-10 pr-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-300">
                    </div>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                            <i data-lucide="lock" class="h-5 w-5 text-slate-400"></i>
                        </span>
                        <input type="password" id="password" placeholder="Password" class="w-full pl-10 pr-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-300">
                    </div>
                </div>
                <button id="login-btn" class="w-full flex justify-center items-center gap-2 bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 active:bg-indigo-800 transition duration-300 font-semibold text-lg hvr-grow">
                    <i data-lucide="log-in" class="h-5 w-5"></i>
                    <span>Login</span>
                </button>
                <p id="login-error" class="text-red-500 text-sm mt-4 text-center h-4"></p>
            </div>
        </div>

        <!-- Konten Aplikasi (Setelah Login) -->
        <div id="app-section" class="hidden">
            <header class="flex flex-wrap justify-between items-center gap-4 mb-8 bg-white p-5 rounded-2xl shadow-md sticky top-4 z-10">
                <div>
                    <h1 class="text-3xl font-bold text-indigo-600">Dasbor Permohonan Kartu</h1>
                    <p class="text-slate-500">Selamat datang kembali, <span id="user-display" class="font-semibold text-indigo-700"></span>!</p>
                </div>
                <div class="flex items-center gap-3">
                    <button id="show-form-btn" class="flex items-center gap-2 bg-indigo-600 text-white px-5 py-2.5 rounded-lg hover:bg-indigo-700 transition duration-300 font-semibold hvr-sweep-to-right">
                        <i data-lucide="plus-circle" class="h-5 w-5"></i>
                        <span>Buat Permohonan</span>
                    </button>
                    <button id="logout-btn" class="flex items-center gap-2 bg-red-500 text-white px-5 py-2.5 rounded-lg hover:bg-red-600 transition duration-300 font-semibold hvr-sweep-to-right">
                        <i data-lucide="log-out" class="h-5 w-5"></i>
                        <span>Logout</span>
                    </button>
                </div>
            </header>

            <!-- Tampilan Dashboard (User & Admin) -->
            <div id="dashboard-section" class="space-y-8">
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <div class="flex flex-wrap justify-between items-center mb-5 gap-4">
                        <h2 class="text-2xl font-bold flex items-center gap-3"><i data-lucide="layout-dashboard" class="text-indigo-600"></i><span id="dashboard-title">Semua Permohonan</span></h2>
                         <button id="back-to-dashboard-btn" class="hidden flex items-center gap-2 bg-slate-600 text-white px-4 py-2 rounded-lg hover:bg-slate-700 transition duration-300 font-semibold hvr-icon-back">
                            <i class="hvr-icon" data-lucide="arrow-left"></i>
                            <span>Kembali ke Dasbor</span>
                        </button>
                    </div>
                    <div id="requests-container" class="overflow-x-auto">
                        <table class="min-w-full bg-white">
                            <thead class="bg-slate-200">
                                <tr>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-slate-600 rounded-l-lg">ID</th>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-slate-600">LPK</th>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-slate-600">PIC</th>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-slate-600">Tgl Kirim</th>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-slate-600">Pemohon</th>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-slate-600">Jumlah</th>
                                    <th class="py-3 px-4 text-center text-sm font-semibold text-slate-600 rounded-r-lg">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="requests-table-body">
                                <!-- Data diisi oleh JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Riwayat Aktivitas (Hanya Admin) -->
                <div id="history-section" class="hidden bg-white p-6 rounded-2xl shadow-lg">
                    <h2 class="text-2xl font-bold mb-5 flex items-center gap-3"><i data-lucide="history" class="text-indigo-600"></i><span>Riwayat Aktivitas</span></h2>
                    <div id="history-container" class="overflow-x-auto max-h-96">
                        <table class="min-w-full bg-white">
                           <thead class="bg-slate-200 sticky top-0">
                                <tr>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-slate-600 rounded-l-lg">Timestamp</th>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-slate-600">User</th>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-slate-600">Aksi</th>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-slate-600 rounded-r-lg">Detail</th>
                                </tr>
                            </thead>
                            <tbody id="history-table-body">
                                <!-- Data diisi oleh JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Form Permohonan (User & Admin) -->
            <div id="user-form-section" class="hidden">
                 <div class="bg-white p-8 rounded-2xl shadow-lg">
                    <h2 class="text-2xl font-bold mb-6 flex items-center gap-3"><i data-lucide="file-plus-2" class="text-indigo-600"></i><span>Form Permohonan Kartu Keluar</span></h2>
                    <input type="hidden" id="form-edit-id">
                    <!-- Bagian Atas -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <input type="text" id="form-lpk" placeholder="LPK" class="uppercase-input w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <input type="text" id="form-pic" placeholder="PIC" class="uppercase-input w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <input type="date" id="form-tanggal" class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-slate-500">
                    </div>

                    <!-- Bagian Tengah (Tabel Dinamis) -->
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold mb-3">Detail Permohonan</h3>
                        <div id="items-container" class="space-y-3">
                            <!-- Baris item akan ditambahkan di sini -->
                        </div>
                        <button id="add-item-btn" class="mt-4 flex items-center gap-2 bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition duration-300 hvr-grow">
                            <i data-lucide="plus" class="h-4 w-4"></i>
                            <span>Tambah Nama</span>
                        </button>
                    </div>

                    <!-- Bagian Bawah -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 border-t pt-6 border-slate-200">
                        <div>
                            <label for="form-penerima" class="block mb-1 font-medium text-sm">Penerima</label>
                            <select id="form-penerima" class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <option>HEGAR</option><option>RIDWAN</option>
                            </select>
                        </div>
                        <div>
                            <label for="form-menyetujui" class="block mb-1 font-medium text-sm">Menyetujui</label>
                            <select id="form-menyetujui" class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <option>SABINE</option>
                            </select>
                        </div>
                        <div>
                            <label for="form-mengetahui" class="block mb-1 font-medium text-sm">Mengetahui</label>
                            <select id="form-mengetahui" class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <option>PAK NOVI</option>
                            </select>
                        </div>
                    </div>

                    <div class="flex justify-end space-x-4">
                        <button id="submit-request-btn" class="flex items-center gap-2 bg-indigo-600 text-white px-6 py-2.5 rounded-lg hover:bg-indigo-700 transition duration-300 font-semibold hvr-sweep-to-right">
                             <i data-lucide="send" class="h-5 w-5"></i>
                            <span>Kirim Permohonan</span>
                        </button>
                        <button id="update-request-btn" class="hidden flex items-center gap-2 bg-amber-500 text-white px-6 py-2.5 rounded-lg hover:bg-amber-600 transition duration-300 font-semibold hvr-sweep-to-right">
                            <i data-lucide="save" class="h-5 w-5"></i>
                            <span>Simpan Perubahan</span>
                        </button>
                    </div>
                 </div>
            </div>
        </div>
        
        <!-- Loading Spinner -->
        <div id="loader" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
            <div class="loader"></div>
        </div>
    </div>

    <script>
        // --- Inisialisasi Lucide Icons ---
        lucide.createIcons();
    
        // --- Kredensial & URL (TIDAK BERUBAH) ---
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyi31_qjJFaRC9f3F55wBpKGFYoRJAoGy2bREmXqCKWEVx0ac8yvPf0Lzaj-5iO5CVR/exec'; 

        // --- Selektor DOM ---
        const loginSection = document.getElementById('login-section');
        const appSection = document.getElementById('app-section');
        const dashboardSection = document.getElementById('dashboard-section');
        const userFormSection = document.getElementById('user-form-section');
        const loader = document.getElementById('loader');
        const userDisplay = document.getElementById('user-display');
        
        let currentUser = null;
        let allRequests = []; // Cache requests

        // --- Fungsi utilitas ---
        const toggleLoader = (show) => loader.classList.toggle('hidden', !show);
        const showView = (view) => {
            dashboardSection.classList.add('hidden');
            userFormSection.classList.add('hidden');
            view.classList.remove('hidden');
            document.getElementById('back-to-dashboard-btn').classList.toggle('hidden', view !== userFormSection);
        };
        
        // --- API Call ---
        async function apiCall(action, payload = {}) {
            toggleLoader(true);
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST', mode: 'cors', cache: 'no-cache',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ action, user: currentUser, ...payload })
                });
                const result = await response.json();
                if (!result.success) throw new Error(result.message || 'Terjadi kesalahan pada server');
                return result.data;
            } catch (error) {
                console.error('API Call Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Terjadi Kesalahan',
                    text: error.message,
                });
                return null;
            } finally {
                toggleLoader(false);
            }
        }

        // --- Logika Autentikasi & Tampilan ---
        async function handleLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const loginError = document.getElementById('login-error');
            loginError.textContent = '';
            if (!username || !password) {
                loginError.textContent = 'Username dan password tidak boleh kosong.';
                return;
            }
            const data = await apiCall('login', { username, password });
            if (data) {
                currentUser = data;
                sessionStorage.setItem('jp-smart-user', JSON.stringify(currentUser));
                showAppView();
            } else {
                loginError.textContent = 'Username atau password salah.';
            }
        }

        function showAppView() {
            if (!currentUser) return;
            loginSection.classList.add('hidden');
            appSection.classList.remove('hidden');
            userDisplay.textContent = currentUser.username;
            
            document.getElementById('history-section').classList.toggle('hidden', currentUser.role !== 'superadmin');
            document.getElementById('dashboard-title').textContent = currentUser.role === 'superadmin' ? 'Semua Permohonan' : 'Permohonan Saya';
            
            loadDashboardData();
            showView(dashboardSection);
            lucide.createIcons(); // Re-render icons on view change
        }

        function handleLogout() {
            currentUser = null;
            sessionStorage.removeItem('jp-smart-user');
            appSection.classList.add('hidden');
            loginSection.classList.remove('hidden');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        // --- Logika Dashboard ---
        async function loadDashboardData() {
            const requests = await apiCall('getRequests');
            if (requests) {
                allRequests = requests;
                renderRequests(requests);
            }

            if (currentUser.role === 'superadmin') {
                const history = await apiCall('getHistory');
                if (history) renderHistory(history);
            }
        }

        function renderRequests(requests) {
            const tbody = document.getElementById('requests-table-body');
            tbody.innerHTML = '';
            if (!requests || requests.length === 0) {
                 tbody.innerHTML = `<tr><td colspan="7" class="text-center py-8 text-slate-500">Tidak ada data permohonan.</td></tr>`;
                 return;
            }
            requests.forEach(req => {
                const items = JSON.parse(req.items);
                const isAdmin = currentUser.role === 'superadmin';
                const actionButtons = `
                    <button class="p-2 rounded-full text-blue-600 bg-blue-100 hover:bg-blue-200 transition-all duration-200 hvr-grow" title="Cetak PDF" onclick="viewDetails('${req.id}')"><i data-lucide="file-text" class="h-4 w-4"></i></button>
                    ${isAdmin ? `
                    <button class="p-2 rounded-full text-yellow-600 bg-yellow-100 hover:bg-yellow-200 transition-all duration-200 hvr-grow" title="Edit" onclick="openEditForm('${req.id}')"><i data-lucide="edit" class="h-4 w-4"></i></button>
                    <button class="p-2 rounded-full text-red-600 bg-red-100 hover:bg-red-200 transition-all duration-200 hvr-grow" title="Hapus" onclick="deleteRequest('${req.id}')"><i data-lucide="trash-2" class="h-4 w-4"></i></button>
                    ` : ''}
                `;
                const row = `
                    <tr class="border-b border-slate-200 odd:bg-white even:bg-slate-50 hover:bg-indigo-50">
                        <td class="py-3 px-4 font-mono text-xs text-slate-500">${req.id}</td>
                        <td class="py-3 px-4 font-medium">${req.lpk}</td>
                        <td class="py-3 px-4 text-slate-600">${req.pic}</td>
                        <td class="py-3 px-4 text-slate-600">${new Date(req.tanggal).toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' })}</td>
                        <td class="py-3 px-4 text-slate-600">${req.submitted_by}</td>
                        <td class="py-3 px-4 font-semibold text-indigo-600">${items.length}</td>
                        <td class="py-3 px-4 text-center">
                            <div class="flex justify-center items-center space-x-2">${actionButtons}</div>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
            lucide.createIcons(); // Render new icons in table
        }
        
        function renderHistory(history) {
            const tbody = document.getElementById('history-table-body');
            tbody.innerHTML = '';
            if (!history || history.length === 0) {
                 tbody.innerHTML = '<tr><td colspan="4" class="text-center py-8 text-slate-500">Tidak ada riwayat aktivitas.</td></tr>';
                 return;
            }
            history.forEach(log => {
                const row = `
                    <tr class="border-b border-slate-200 odd:bg-white even:bg-slate-50">
                        <td class="py-3 px-4 text-slate-600">${new Date(log.timestamp).toLocaleString('id-ID')}</td>
                        <td class="py-3 px-4 font-medium">${log.user}</td>
                        <td class="py-3 px-4 text-slate-600">${log.action}</td>
                        <td class="py-3 px-4 text-slate-500 text-sm">${log.details}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        // --- Aksi pada Dashboard ---
        window.viewDetails = (id) => {
            const request = allRequests.find(r => r.id === id);
            if (request) generatePDF(request, false);
        };

        window.deleteRequest = async (id) => {
            Swal.fire({
                title: 'Anda yakin?',
                text: `Permohonan dengan ID ${id} akan dihapus secara permanen!`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#64748b',
                confirmButtonText: 'Ya, hapus!',
                cancelButtonText: 'Batal'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    if (await apiCall('deleteRequest', { id })) {
                        Swal.fire(
                            'Dihapus!',
                            'Permohonan telah berhasil dihapus.',
                            'success'
                        );
                        loadDashboardData();
                    }
                }
            });
        };

        window.openEditForm = (id) => {
            const request = allRequests.find(r => r.id === id);
            if (!request) return;
            
            document.getElementById('form-edit-id').value = request.id;
            document.getElementById('form-lpk').value = request.lpk;
            document.getElementById('form-pic').value = request.pic;
            document.getElementById('form-tanggal').value = new Date(request.tanggal).toISOString().split('T')[0];
            document.getElementById('form-penerima').value = request.penerima;
            document.getElementById('form-menyetujui').value = request.menyetujui;
            document.getElementById('form-mengetahui').value = request.mengetahui;

            const itemsContainer = document.getElementById('items-container');
            itemsContainer.innerHTML = '';
            JSON.parse(request.items).forEach(item => createItemRow(item.name, item.type, item.iccid));

            document.getElementById('submit-request-btn').classList.add('hidden');
            document.getElementById('update-request-btn').classList.remove('hidden');
            showView(userFormSection);
        };

        // --- Logika Form ---
        const itemsContainer = document.getElementById('items-container');
        
        function createItemRow(name = '', type = 'CALL SIM', iccid = '') {
            const row = document.createElement('div');
            row.className = 'flex items-center space-x-2 item-row bg-slate-50 p-2 rounded-lg';
            row.innerHTML = `
                <input type="text" placeholder="Nama" class="uppercase-input w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 item-name" value="${name}">
                <select class="w-48 px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 item-type">
                    <option ${type === 'CALL SIM' ? 'selected' : ''}>CALL SIM</option>
                    <option ${type === 'DATA SIM' ? 'selected' : ''}>DATA SIM</option>
                </select>
                <input type="text" placeholder="ICCID (Opsional)" class="uppercase-input w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 item-iccid" value="${iccid}">
                <button type="button" class="bg-red-500 text-white p-2 rounded-lg hover:bg-red-600 transition hvr-buzz-out" onclick="this.parentElement.remove()"><i data-lucide="x" class="h-5 w-5"></i></button>
            `;
            itemsContainer.appendChild(row);
            lucide.createIcons(); // Render icon for new row
        }

        function resetAndSetupUserForm(){
            document.getElementById('form-edit-id').value = '';
            document.getElementById('form-lpk').value = '';
            document.getElementById('form-pic').value = '';
            document.getElementById('form-tanggal').valueAsDate = new Date();
            itemsContainer.innerHTML = '';
            createItemRow();

            document.getElementById('submit-request-btn').classList.remove('hidden');
            document.getElementById('update-request-btn').classList.add('hidden');
            showView(userFormSection);
        }

        function getFormData() {
            const lpk = document.getElementById('form-lpk').value.toUpperCase();
            const pic = document.getElementById('form-pic').value.toUpperCase();
            const tanggal = document.getElementById('form-tanggal').value;
            if (!lpk || !pic || !tanggal) {
                Swal.fire('Data Tidak Lengkap', 'LPK, PIC, dan Tanggal Kirim harus diisi.', 'warning');
                return null;
            }

            const items = [];
            document.querySelectorAll('.item-row').forEach(row => {
                const name = row.querySelector('.item-name').value.toUpperCase();
                const type = row.querySelector('.item-type').value;
                const iccid = row.querySelector('.item-iccid').value.toUpperCase() || '';
                if(name) {
                   items.push({ name, type, iccid });
                }
            });
            
            if (items.length === 0) {
                 Swal.fire('Detail Kosong', 'Minimal harus ada satu baris dengan Nama yang terisi.', 'warning');
                 return null;
            }

            return {
                id: document.getElementById('form-edit-id').value,
                lpk, pic, tanggal, 
                items: JSON.stringify(items), 
                penerima: document.getElementById('form-penerima').value, 
                menyetujui: document.getElementById('form-menyetujui').value, 
                mengetahui: document.getElementById('form-mengetahui').value
            };
        }

        async function submitRequest() {
            const formData = getFormData();
            if (!formData) return;
            
            if (await apiCall('submitRequest', formData)) {
                Swal.fire('Berhasil!', 'Permohonan berhasil dikirim.', 'success');
                showAppView();
            }
        }
        
        async function updateRequest() {
            const formData = getFormData();
            if (!formData) return;
            
            if (await apiCall('updateRequest', formData)) {
                 Swal.fire('Berhasil!', 'Permohonan berhasil diperbarui.', 'success');
                showAppView();
            }
        }

        // --- Generate PDF (Fungsi tidak berubah, hanya untuk kelengkapan) ---
        function generatePDF(data, autoDownload = true, logoBase64 = "") {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF("p", "mm", "a4");
        const formData = data;
        if (!formData) return;

        const items = JSON.parse(formData.items);
        const tableData = items.map((item, index) => [
            index + 1,
            item.name,
            item.type,
            item.iccid
        ]);

        // ===== WATERMARK =====
        doc.setTextColor(200, 200, 200);
        doc.setFontSize(60);
        doc.setFont("helvetica", "bold");
        doc.text("JP SMART", 105, 150, { angle: 45, align: "center" });

        // ===== HEADER =====
        if (logoBase64) {
            doc.addImage(logoBase64, "PNG", 170, 10, 25, 25); // logo pojok kanan atas
        }

        doc.setTextColor(50, 50, 50);
        doc.setFontSize(18);
        doc.setFont("helvetica", "bold");
        doc.text("FORM PERMOHONAN KARTU KELUAR", 105, 20, { align: "center" });

        doc.setFontSize(12);
        doc.setFont("helvetica", "normal");
        doc.setTextColor(90, 90, 90);
        doc.text("JAPANINDO TRAVEL CONNECTION", 105, 27, { align: "center" });

        doc.setDrawColor(79, 70, 229);
        doc.setLineWidth(0.5);
        doc.line(20, 32, 190, 32);

        // ===== METADATA (rapihin label & nilai) =====
        const metaX = 14;
        const valX = 55;
        let currentY = 42;

        doc.setFontSize(11);
        doc.setTextColor(0, 0, 0);

        const metaData = [
            ["ID", formData.id],
            ["LPK", formData.lpk],
            ["PIC", formData.pic],
            ["TANGGAL KIRIM", new Date(formData.tanggal)
                .toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' })]
        ];

        metaData.forEach(([label, value]) => {
            doc.text(`${label} :`, metaX, currentY);
            doc.text(String(value), valX, currentY);
            currentY += 6;
        });

        // ===== TABLE =====
        doc.autoTable({
            head: [['No.', 'NAMA', 'TYPE KARTU', 'ICCID']],
            body: tableData,
            startY: currentY + 4,
            theme: 'grid',
            styles: {
                font: "helvetica",
                fontSize: 10,
                cellPadding: 3,
                overflow: 'linebreak'   // wrap teks panjang
            },
            headStyles: {
                fillColor: [79, 70, 229],
                textColor: [255, 255, 255],
                fontStyle: 'bold'
            },
            bodyStyles: { fillColor: [248, 250, 252] },
            alternateRowStyles: { fillColor: [255, 255, 255] },
            columnStyles: {
                0: { cellWidth: 12 },
                1: { cellWidth: 60 },   // nama cukup lebar
                2: { cellWidth: 35 },
                3: { cellWidth: 'auto' }
            }
        });

        // ===== SIGNATURE =====
        const finalY = doc.autoTable.previous.finalY;
        const signatureY = finalY + 25;

        doc.setFontSize(11);
        doc.text('Penerima', 35, signatureY, { align: 'center' });
        doc.text('Menyetujui', 105, signatureY, { align: 'center' });
        doc.text('Mengetahui', 175, signatureY, { align: 'center' });

        doc.text(`(${formData.penerima})`, 35, signatureY + 20, { align: 'center' });
        doc.text(`(${formData.menyetujui})`, 105, signatureY + 20, { align: 'center' });
        doc.text(`(${formData.mengetahui})`, 175, signatureY + 20, { align: 'center' });

        // ===== FOOTER =====
        doc.setFontSize(9);
        doc.setTextColor(120, 120, 120);
        doc.text("Generated by JP SMART System", 105, 290, { align: "center" });

        if (autoDownload) doc.save(`Permohonan-${formData.id}.pdf`);
        else doc.output('dataurlnewwindow');
    }


        // --- Event Listeners ---
        document.getElementById('login-btn').addEventListener('click', handleLogin);
        document.getElementById('password').addEventListener('keypress', (e) => e.key === 'Enter' && handleLogin());
        document.getElementById('logout-btn').addEventListener('click', handleLogout);
        document.getElementById('show-form-btn').addEventListener('click', resetAndSetupUserForm);
        document.getElementById('back-to-dashboard-btn').addEventListener('click', () => showView(dashboardSection));
        document.getElementById('add-item-btn').addEventListener('click', () => createItemRow());
        document.getElementById('submit-request-btn').addEventListener('click', submitRequest);
        document.getElementById('update-request-btn').addEventListener('click', updateRequest);

        // Cek sesi saat halaman dimuat
        document.addEventListener('DOMContentLoaded', () => {
            const savedUser = sessionStorage.getItem('jp-smart-user');
            if(savedUser) {
                currentUser = JSON.parse(savedUser);
                showAppView();
            } else {
                lucide.createIcons();
            }
        });
    </script>
</body>
</html>
